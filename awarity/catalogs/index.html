<!DOCTYPE html>
<html lang="en" class="fluentlm fluent-dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catalogs — Awarity</title>
  <!-- Combined library CSS (base) then theme overrides -->
  <link rel="stylesheet" href="../themes/fluentlm.min.css">
  <link rel="stylesheet" href="../themes/theme-dark.css">
  <link rel="stylesheet" href="../themes/theme-awarity-light.css">
  <link rel="stylesheet" href="../themes/theme-awarity-dark.css">
  <link rel="stylesheet" href="../themes/theme-awarity-amber-light.css">
  <link rel="stylesheet" href="../themes/theme-awarity-amber-dark.css">

  <style>
    /* ── App Shell ── */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    .app-shell {
      display: flex;
      min-height: 100vh;
    }

    /* ── Left Nav ── */
    .app-nav {
      width: 220px;
      flex-shrink: 0;
      background-color: var(--bodyStandoutBackground);
      border-right: 1px solid var(--bodyFrameDivider);
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }

    .app-nav-brand {
      padding: var(--spacingM);
      font-size: var(--fontSizeXLarge);
      font-weight: var(--fontWeightSemibold);
      line-height: var(--lineHeightXLarge);
      color: var(--bodyText);
      border-bottom: 1px solid var(--bodyFrameDivider);
    }

    .app-nav-section {
      padding: var(--spacingS2) var(--spacingM);
      margin-top: var(--spacingM);
      font-size: var(--fontSizeTiny);
      font-weight: var(--fontWeightSemibold);
      color: var(--bodySubtext);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .app-nav-link {
      display: flex;
      align-items: center;
      gap: var(--spacingS1);
      padding: var(--spacingS2) var(--spacingM);
      color: var(--bodyText);
      font-size: var(--fontSizeMedium);
      text-decoration: none;
      cursor: pointer;
      border-left: 3px solid transparent;
    }

    .app-nav-link:hover {
      background-color: var(--listItemBackgroundHovered);
      text-decoration: none;
    }

    .app-nav-link--active {
      background-color: var(--listItemBackgroundChecked);
      font-weight: var(--fontWeightSemibold);
      border-left-color: var(--themePrimary);
    }

    .app-nav-spacer { flex: 1; }

    /* ── Main Area ── */
    .app-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── CommandBar Zone ── */
    .app-commandbar {
      border-bottom: 1px solid var(--bodyDivider);
    }

    /* ── Breadcrumb Zone ── */
    .app-breadcrumb {
      padding: var(--spacingS2) var(--spacingL2);
      border-bottom: 1px solid var(--bodyDivider);
      background-color: var(--bodyBackground);
    }

    /* ── MessageBar Zone ── */
    .app-messagebar-zone {
      padding: 0 var(--spacingL2);
    }
    .app-messagebar-zone:empty { display: none; }
    .app-messagebar-zone .flm-messagebar {
      margin-top: var(--spacingS1);
      border-radius: var(--roundedCorner4);
    }

    /* ── Content Area ── */
    .app-content {
      flex: 1;
      padding: var(--spacingL2);
      overflow-y: auto;
      background-color: var(--bodyBackground);
    }

    /* ── Horizontal scroll for table ── */
    #catalogs-list {
      overflow-x: auto;
    }
    #catalogs-list .flm-detailslist-header,
    #catalogs-list .flm-detailslist-row {
      min-width: max-content;
    }

    /* ── Empty State ── */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      gap: var(--spacingM);
      color: var(--bodySubtext);
    }

    .empty-state-icon {
      font-size: 48px;
      opacity: 0.4;
    }

    .empty-state-text {
      font-size: var(--fontSizeLarge);
      color: var(--bodySubtext);
    }

    .empty-state-sub {
      font-size: var(--fontSizeMedium);
      color: var(--bodySubtext);
      opacity: 0.7;
      max-width: 360px;
      text-align: center;
      line-height: var(--lineHeightMedium);
    }

    /* ── Status Badges ── */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px var(--spacingS1);
      border-radius: var(--roundedCorner4);
      font-size: var(--fontSizeSmall);
      font-weight: var(--fontWeightSemibold);
    }

    .status-badge--ready {
      background-color: color-mix(in srgb, var(--green) 15%, transparent);
      color: var(--green);
    }

    .status-badge--warning {
      background-color: color-mix(in srgb, var(--yellow) 15%, transparent);
      color: var(--yellow);
    }

    .status-badge--processing {
      background-color: color-mix(in srgb, var(--blue) 15%, transparent);
      color: var(--blue);
    }

    .status-badge--error {
      background-color: color-mix(in srgb, var(--red) 15%, transparent);
      color: var(--red);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: currentColor;
    }

    /* ── Inline Progress (in table row) ── */
    .row-progress {
      margin-top: 4px;
    }
    .row-progress .flm-progress-track {
      height: 3px;
    }

    /* ── Panel Sections ── */
    .panel-section {
      margin-bottom: var(--spacingL2);
    }

    .panel-section-title {
      font-size: var(--fontSizeMedium);
      font-weight: var(--fontWeightSemibold);
      color: var(--bodyText);
      margin-bottom: var(--spacingS1);
      text-transform: uppercase;
      font-size: var(--fontSizeTiny);
      letter-spacing: 0.5px;
      color: var(--bodySubtext);
    }

    .panel-meta {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: var(--spacingS2) var(--spacingM);
      font-size: var(--fontSizeMedium);
    }

    .panel-meta-label {
      color: var(--bodySubtext);
    }

    .panel-meta-value {
      color: var(--bodyText);
    }

    .panel-actions {
      display: flex;
      flex-direction: column;
      gap: var(--spacingS2);
    }

    .panel-actions .flm-button {
      justify-content: flex-start;
    }

    .panel-activity-item {
      display: flex;
      justify-content: space-between;
      padding: var(--spacingS2) 0;
      border-bottom: 1px solid var(--bodyDivider);
      font-size: var(--fontSizeSmall);
    }

    .panel-activity-item:last-child {
      border-bottom: none;
    }

    .panel-activity-label { color: var(--bodyText); }
    .panel-activity-time { color: var(--bodySubtext); }

    /* ── Panel Form ── */
    .panel-form {
      display: flex;
      flex-direction: column;
      gap: var(--spacingM);
    }

    /* ── Dirty Badge ── */
    .dirty-badge {
      display: none;
      margin-bottom: var(--spacingM);
    }

    .dirty-badge--visible {
      display: block;
    }

    /* ── Usage Sections ── */
    .usage-section {
      margin-bottom: var(--spacingL1);
    }

    .usage-section-title {
      font-size: var(--fontSizeMedium);
      font-weight: var(--fontWeightSemibold);
      color: var(--bodyText);
      margin-bottom: var(--spacingS2);
    }

    .usage-empty {
      font-size: var(--fontSizeMedium);
      color: var(--bodySubtext);
      padding: var(--spacingM) 0;
    }

    .usage-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacingS2) 0;
      border-bottom: 1px solid var(--bodyDivider);
      font-size: var(--fontSizeMedium);
    }

    .usage-item:last-child { border-bottom: none; }

    .usage-item-name { color: var(--bodyText); }

    .usage-item-date { color: var(--bodySubtext); font-size: var(--fontSizeSmall); }

    /* ── Category Input (picker) ── */
    .category-input-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 4px;
      border: 1px solid var(--inputBorder);
      border-radius: var(--roundedCorner4);
      background-color: var(--inputBackground);
      min-height: 32px;
      align-items: center;
      cursor: text;
    }

    .category-input-wrap:focus-within {
      border-color: var(--themePrimary);
    }

    .category-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 1px 6px;
      border-radius: var(--roundedCorner4);
      font-size: var(--fontSizeSmall);
      background-color: color-mix(in srgb, var(--themePrimary) 15%, transparent);
      color: var(--themePrimary);
    }

    .category-tag-remove {
      cursor: pointer;
      font-size: 10px;
      opacity: 0.7;
      background: none;
      border: none;
      color: inherit;
      padding: 0;
      line-height: 1;
    }

    .category-tag-remove:hover { opacity: 1; }

    .category-input {
      border: none;
      outline: none;
      background: transparent;
      font-size: var(--fontSizeMedium);
      color: var(--bodyText);
      flex: 1;
      min-width: 80px;
      font-family: inherit;
    }

    .category-suggestions {
      display: none;
      position: absolute;
      z-index: 10;
      background-color: var(--bodyBackground);
      border: 1px solid var(--bodyDivider);
      border-radius: var(--roundedCorner4);
      max-height: 160px;
      overflow-y: auto;
      margin-top: 2px;
      min-width: 160px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .category-suggestion {
      padding: var(--spacingS2) var(--spacingM);
      font-size: var(--fontSizeMedium);
      color: var(--bodyText);
      cursor: pointer;
    }

    .category-suggestion:hover {
      background-color: var(--listItemBackgroundHovered);
    }

    /* ── Filter bar layout ── */
    .filter-bar {
      display: flex;
      align-items: center;
      gap: var(--spacingS1);
      margin-bottom: var(--spacingS1);
    }
    .filter-bar #category-filter { flex: 1; margin-bottom: 0; }

    /* ── View dropdown ── */
    .view-dropdown-wrapper { position: relative; }
    .view-dropdown-btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 12px; border-radius: 16px;
      border: 1px solid var(--bodyDivider);
      background: transparent; color: var(--bodySubtext);
      font-size: var(--fontSizeSmall); font-family: inherit;
      cursor: pointer;
    }
    .view-dropdown-btn:hover { border-color: var(--themePrimary); color: var(--themePrimary); }
    .view-dropdown-menu {
      display: none; position: absolute; right: 0; top: calc(100% + 4px);
      min-width: 180px; background: var(--bodyBackground);
      border: 1px solid var(--bodyDivider); border-radius: var(--roundedCorner4);
      box-shadow: var(--elevation8); z-index: 10; padding: 4px 0;
    }
    .view-dropdown-menu--open { display: block; }
    .view-dropdown-item {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 12px; font-size: var(--fontSizeSmall);
      color: var(--bodyText); cursor: pointer; width: 100%;
      background: none; border: none; font-family: inherit; text-align: left;
    }
    .view-dropdown-item:hover { background: var(--listItemBackgroundHovered); }

    /* ── Category filter pills ── */
    #category-filter { margin-bottom: var(--spacingS1); }
    .filter-pill {
      border-radius: 16px; padding: 4px 14px;
      border: 1px solid var(--bodyDivider);
      background: transparent; color: var(--bodySubtext);
      font-size: var(--fontSizeSmall); font-family: inherit;
      cursor: pointer; transition: border-color 0.15s, color 0.15s, background 0.15s;
    }
    .filter-pill:hover { border-color: var(--themePrimary); color: var(--themePrimary); }
    .filter-pill--active { background: var(--themePrimary); color: var(--white); border-color: transparent; }

    /* ── Category chips ── */
    .category-chips { display: flex; flex-wrap: wrap; gap: 4px; }
    .category-chip {
      display: inline-block; padding: 1px 8px;
      border-radius: var(--roundedCorner4);
      font-size: var(--fontSizeSmall);
      background-color: color-mix(in srgb, var(--themePrimary) 15%, transparent);
      color: var(--themePrimary);
      cursor: pointer;
    }
    .category-chip:hover {
      background-color: color-mix(in srgb, var(--themePrimary) 30%, transparent);
    }

    /* ── Pivot tabs ── */
    .pivot-bar {
      display: flex;
      border-bottom: 1px solid var(--bodyDivider);
      background-color: var(--bodyStandoutBackground);
      margin: 0 calc(-1 * var(--spacingL1));
      padding: 0 var(--spacingL1);
    }
    .pivot-tab {
      padding: var(--spacingS2) var(--spacingL1);
      font-size: var(--fontSizeMedium);
      color: var(--bodySubtext);
      cursor: pointer; border: none; background: none;
      border-bottom: 2px solid transparent;
      font-family: inherit; transition: color 0.15s;
    }
    .pivot-tab:hover { color: var(--bodyText); }
    .pivot-tab--active {
      color: var(--themePrimary);
      border-bottom-color: var(--themePrimary);
      font-weight: var(--fontWeightSemibold);
    }
    .pivot-panel { display: none; padding-top: var(--spacingM); }
    .pivot-panel--active { display: block; }

    /* ── Panel footer ── */
    .panel-footer-actions {
      display: flex; gap: var(--spacingS1); align-items: center;
    }
    .panel-footer-right {
      margin-left: auto; display: flex; gap: var(--spacingS1);
    }

    /* ── Clickable rows ── */
    .flm-detailslist-row { cursor: pointer; }

    /* ── Shimmer loading table ── */
    .shimmer-table {
      display: flex;
      flex-direction: column;
      gap: var(--spacingS2);
    }

    .shimmer-row {
      display: flex;
      gap: var(--spacingM);
      padding: var(--spacingS1) 0;
    }

    /* ── Number cells right-aligned ── */
    .cell-number {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
  </style>
</head>
<body>
  <div class="app-shell">

    <!-- ════════════════════════════════════════════════════════════════
         LEFT NAV
         ════════════════════════════════════════════════════════════════ -->
    <nav class="app-nav">
      <div class="app-nav-brand">Awarity</div>

      <a class="app-nav-link" href="../home/index.html"><svg viewBox="0 0 64 64" width="16" height="16" style="flex-shrink:0;"><rect x="6" y="6" width="52" height="52" rx="14" fill="none" stroke="currentColor" stroke-width="6"/><path d="M22 46 32 18l10 28h-6l-2-6h-4l-2 6Z" fill="currentColor"/><path d="M29 34h6l-3-9Z" fill="var(--bodyStandoutBackground)"/></svg> Home</a>
      <a class="app-nav-link app-nav-link--active" href="#"><i class="flm-icon" data-icon="Database"></i> Catalogs</a>
      <a class="app-nav-link" href="../explorer/index.html"><i class="flm-icon" data-icon="Search"></i> Explore</a>
      <a class="app-nav-link" href="../structure/index.html"><i class="flm-icon" data-icon="Org"></i> Structure</a>
      <a class="app-nav-link" href="../lenses/index.html"><i class="flm-icon" data-icon="Filter"></i> Lenses</a>
      <a class="app-nav-link" href="../workflows/index.html"><i class="flm-icon" data-icon="Flow"></i> Workflows</a>
      <a class="app-nav-link" href="../runs/index.html"><i class="flm-icon" data-icon="Processing"></i> Runs</a>

      <div class="app-nav-spacer"></div>

      <a class="app-nav-link" href="../settings/index.html"><i class="flm-icon" data-icon="Settings"></i> Settings</a>

      <div style="padding: var(--spacingM);">
        <button class="flm-button" id="themeToggle" style="width: 100%;">Switch to Dark</button>
      </div>
    </nav>

    <!-- ════════════════════════════════════════════════════════════════
         MAIN AREA
         ════════════════════════════════════════════════════════════════ -->
    <div class="app-main">

      <!-- CommandBar -->
      <div class="app-commandbar">
        <div class="flm-commandbar">
          <div class="flm-commandbar-items">
            <button class="flm-button flm-button--primary" data-icon="Add" id="btn-new-catalog" style="margin: 4px 8px;">
              New Catalog
            </button>
            <button class="flm-commandbar-item" data-icon="TextDocument" id="btn-generate" disabled>Generate Abstracts</button>
            <button class="flm-commandbar-item" data-icon="Delete" id="btn-delete" disabled>Delete</button>
            <span class="flm-commandbar-divider"></span>
            <button class="flm-commandbar-item" data-icon="Refresh" id="btn-refresh">Refresh</button>
            <span class="flm-commandbar-divider"></span>
            <button class="flm-commandbar-item" id="btn-ask-awarity"><svg viewBox="0 0 64 64" width="16" height="16" style="flex-shrink:0;vertical-align:middle;margin-right:4px;"><rect x="6" y="6" width="52" height="52" rx="14" fill="none" stroke="currentColor" stroke-width="6"/><path d="M22 46 32 18l10 28h-6l-2-6h-4l-2 6Z" fill="currentColor"/><path d="M29 34h6l-3-9Z" fill="var(--bodyBackground)"/></svg>Ask Awarity</button>
          </div>
          <div class="flm-commandbar-far" style="align-items: center; padding-right: 8px;">
            <div class="flm-searchbox" style="min-width: 220px;">
              <input class="flm-searchbox-input" type="text" placeholder="Search catalogs…" id="search-input">
            </div>
          </div>
        </div>
      </div>

      <!-- Breadcrumb -->
      <div class="app-breadcrumb">
        <ol class="flm-breadcrumb">
          <li class="flm-breadcrumb-item"><a class="flm-breadcrumb-link" href="../home/index.html">Home</a></li>
          <li class="flm-breadcrumb-item"><a class="flm-breadcrumb-link">Catalogs</a></li>
        </ol>
      </div>

      <!-- MessageBar Zone -->
      <div class="app-messagebar-zone" id="messagebar-zone"></div>

      <!-- Content -->
      <div class="app-content" id="content-area">

        <!-- ── Loading State (Shimmer) ── -->
        <div id="state-loading" style="display: none;">
          <div class="shimmer-table">
            <div class="shimmer-row">
              <div class="flm-shimmer" style="flex: 2;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
            </div>
            <div class="shimmer-row">
              <div class="flm-shimmer" style="flex: 2;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
            </div>
            <div class="shimmer-row">
              <div class="flm-shimmer" style="flex: 2;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
            </div>
            <div class="shimmer-row">
              <div class="flm-shimmer" style="flex: 2;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
            </div>
            <div class="shimmer-row">
              <div class="flm-shimmer" style="flex: 2;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
              <div class="flm-shimmer" style="flex: 1;"><div class="flm-shimmer-line"></div></div>
            </div>
          </div>
        </div>

        <!-- ── Empty State ── -->
        <div id="state-empty" style="display: none;">
          <div class="empty-state">
            <i class="flm-icon empty-state-icon" data-icon="Database"></i>
            <span class="empty-state-text">No catalogs yet</span>
            <span class="empty-state-sub">Catalogs store your document corpus. Create one to begin reasoning over your data.</span>
            <button class="flm-button flm-button--primary" data-icon="Add" id="btn-empty-create">
              <i class="flm-icon" data-icon="Add"></i> Create your first catalog
            </button>
          </div>
        </div>

        <!-- ── Data State (DetailsList) ── -->
        <div id="state-data" style="display: block;">
          <div class="filter-bar">
            <div class="flm-overflowset" id="category-filter">
              <div class="flm-overflowset-items"></div>
              <button class="flm-overflowset-overflow" aria-label="More categories">...</button>
            </div>
            <div class="view-dropdown-wrapper">
              <button class="view-dropdown-btn" id="view-dropdown-btn">
                <i class="flm-icon" data-icon="ViewList"></i> View
              </button>
              <div class="view-dropdown-menu" id="view-dropdown-menu"></div>
            </div>
          </div>
          <div class="flm-detailslist" id="catalogs-list">
            <div class="flm-detailslist-header" id="catalogs-header"></div>
            <!-- Rows populated by JS -->
          </div>
        </div>

      </div><!-- /app-content -->
    </div><!-- /app-main -->
  </div><!-- /app-shell -->

  <!-- ════════════════════════════════════════════════════════════════
       DETAIL PANEL (right slide-over)
       ════════════════════════════════════════════════════════════════ -->
  <div class="flm-panel-overlay" id="detail-panel-overlay"></div>
  <div class="flm-panel flm-panel--medium" id="detail-panel">
    <div class="flm-panel-header">
      <h2 class="flm-panel-title" id="detail-panel-title">sec-filings</h2>
      <span style="font-size: var(--fontSizeSmall); color: var(--bodySubtext); margin-left: var(--spacingS1);" id="detail-panel-subtitle"></span>
      <button class="flm-panel-close" data-icon="Cancel" aria-label="Close" id="detail-panel-close"></button>
    </div>
    <div class="flm-panel-body">

      <!-- Quick Actions -->
      <div style="display: flex; gap: var(--spacingS1); margin-bottom: var(--spacingM);">
        <button class="flm-button" id="btn-use-explore"><i class="flm-icon" data-icon="Search"></i> Use in Explore</button>
        <button class="flm-button" id="btn-use-workflow"><i class="flm-icon" data-icon="Flow"></i> Use in Workflow</button>
      </div>

      <!-- Dirty badge -->
      <div class="dirty-badge" id="dirty-badge">
        <div class="flm-messagebar flm-messagebar--warning">You have unsaved changes.</div>
      </div>

      <!-- Error banner (shown for error catalogs) -->
      <div id="detail-error-bar" style="display: none; margin-bottom: var(--spacingM);">
        <div class="flm-messagebar flm-messagebar--error">Ingest failed: unable to parse 12 documents. Check source files for encoding issues.</div>
      </div>

      <!-- Tabs -->
      <div class="pivot-bar" id="detail-pivot-bar">
        <button class="pivot-tab pivot-tab--active" data-tab="edit">Edit</button>
        <button class="pivot-tab" data-tab="abstracts">Abstracts</button>
        <button class="pivot-tab" data-tab="usage">Usage</button>
      </div>

      <!-- ── Tab: Edit ── -->
      <div class="pivot-panel pivot-panel--active" id="tab-edit">
        <div class="panel-form">
          <div class="flm-textfield flm-textfield--required">
            <label class="flm-label" for="edit-name">Name</label>
            <input class="flm-textfield-input" id="edit-name" placeholder="e.g. sec-filings">
          </div>
          <div class="flm-textfield">
            <label class="flm-label" for="edit-description">Description</label>
            <textarea class="flm-textfield-input" id="edit-description" rows="2" style="width: 100%; resize: vertical;" placeholder="Optional description"></textarea>
          </div>
          <div>
            <label class="flm-label">Categories</label>
            <div style="position: relative;">
              <div class="category-input-wrap" id="edit-categories-wrap">
                <input class="category-input" id="edit-categories-input" placeholder="Add category…">
              </div>
              <div class="category-suggestions" id="edit-categories-suggestions"></div>
            </div>
          </div>
        </div>

        <!-- Details (read-only) -->
        <div class="panel-section" style="margin-top: var(--spacingL1);">
          <div class="panel-section-title">Details</div>
          <div class="panel-meta">
            <span class="panel-meta-label">Documents</span>
            <span class="panel-meta-value" id="detail-documents">2,341</span>
            <span class="panel-meta-label">Chunks</span>
            <span class="panel-meta-value" id="detail-chunks">18,420</span>
            <span class="panel-meta-label">Abstracts</span>
            <span class="panel-meta-value" id="detail-abstracts">2,341</span>
            <span class="panel-meta-label">Classifications</span>
            <span class="panel-meta-value" id="detail-classifications">3</span>
            <span class="panel-meta-label">Location</span>
            <span class="panel-meta-value" id="detail-location">~/.awarity/catalogs/sec-filings</span>
            <span class="panel-meta-label">Created</span>
            <span class="panel-meta-value" id="detail-created">Feb 14, 2026</span>
            <span class="panel-meta-label">Status</span>
            <span class="panel-meta-value" id="detail-status"><span class="status-badge status-badge--ready"><span class="status-dot"></span> Ready</span></span>
          </div>
        </div>
      </div>

      <!-- ── Tab: Abstracts ── -->
      <div class="pivot-panel" id="tab-abstracts">
        <div class="panel-section">
          <div class="panel-meta" style="margin-bottom: var(--spacingM);">
            <span class="panel-meta-label">Abstract Count</span>
            <span class="panel-meta-value" id="detail-abstract-count">2,341</span>
          </div>
        </div>
        <div class="flm-textfield">
          <label class="flm-label" for="edit-abstract-rules">Generation Rules</label>
          <textarea class="flm-textfield-input" id="edit-abstract-rules" rows="12" style="width: 100%; resize: vertical; font-family: monospace;" placeholder="Enter abstract generation rules…"></textarea>
        </div>
      </div>

      <!-- ── Tab: Usage ── -->
      <div class="pivot-panel" id="tab-usage">
        <div class="usage-section">
          <div class="usage-section-title">Explore queries using this catalog</div>
          <div id="usage-explore"></div>
        </div>
        <div class="usage-section">
          <div class="usage-section-title">Workflows using this catalog</div>
          <div id="usage-workflows"></div>
        </div>
        <div class="usage-section">
          <div class="usage-section-title">Classification runs using this catalog</div>
          <div id="usage-classifications"></div>
        </div>
      </div>

    </div>
    <div class="flm-panel-footer">
      <div class="panel-footer-actions">
        <button class="flm-button" id="detail-panel-close-btn">Close</button>
        <button class="flm-button flm-button--primary" id="btn-save-catalog" disabled>Save</button>
        <div class="panel-footer-right">
          <button class="flm-button" id="btn-delete-catalog" style="color: var(--red);"><i class="flm-icon" data-icon="Delete"></i> Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════════════════════════════════
       NEW CATALOG WIZARD DIALOG
       ════════════════════════════════════════════════════════════════ -->
  <div class="flm-dialog-overlay" id="new-catalog-dialog" data-light-dismiss style="z-index: 1002;">
    <div class="flm-dialog" style="max-width: 520px;">
      <div class="flm-dialog-header">
        <h2 class="flm-dialog-title">New Catalog</h2>
        <button class="flm-dialog-close" data-icon="Cancel" aria-label="Close" data-dialog-close></button>
      </div>
      <div class="flm-dialog-body">

        <!-- Step 1: Source -->
        <div id="new-step-1">
          <div class="panel-form">
            <div>
              <label class="flm-label">Source Type</label>
              <div class="flm-choicegroup" style="margin-top: var(--spacingS2);">
                <label class="flm-choicegroup-option">
                  <input type="radio" class="flm-choicegroup-input" name="source-type" value="folder" checked>
                  <span class="flm-choicegroup-mark"></span>
                  <span class="flm-choicegroup-label">Folder</span>
                </label>
                <label class="flm-choicegroup-option">
                  <input type="radio" class="flm-choicegroup-input" name="source-type" value="filelist">
                  <span class="flm-choicegroup-mark"></span>
                  <span class="flm-choicegroup-label">File list</span>
                </label>
              </div>
            </div>

            <div class="flm-textfield flm-textfield--required">
              <label class="flm-label" for="new-path">Path</label>
              <div class="flm-textfield-wrapper">
                <input class="flm-textfield-input" id="new-path" placeholder="/path/to/documents">
                <button class="flm-button flm-button--icon" type="button" id="btn-browse" aria-label="Browse" data-tooltip="Browse for folder" style="flex-shrink: 0; border: none; background: transparent;"><i class="flm-icon" data-icon="FolderOpen"></i></button>
              </div>
              <input type="file" id="file-picker" webkitdirectory style="display: none;">
            </div>

            <label class="flm-checkbox" style="margin-top: var(--spacingS2);">
              <input type="checkbox" class="flm-checkbox-input" id="new-auto-abstracts">
              <span class="flm-checkbox-mark"></span>
              <span class="flm-label">Auto-generate abstracts after ingest</span>
            </label>
          </div>
        </div>

        <!-- Step 2: Details -->
        <div id="new-step-2" style="display: none;">
          <div class="panel-form">
            <div class="flm-textfield flm-textfield--required">
              <label class="flm-label" for="new-name">Name</label>
              <input class="flm-textfield-input" id="new-name" placeholder="e.g. sec-filings">
            </div>
            <div class="flm-textfield">
              <label class="flm-label" for="new-description">Description</label>
              <textarea class="flm-textfield-input" id="new-description" rows="2" style="width: 100%; resize: vertical;" placeholder="Optional description"></textarea>
            </div>
            <div>
              <label class="flm-label">Categories</label>
              <div style="position: relative;">
                <div class="category-input-wrap" id="new-categories-wrap">
                  <input class="category-input" id="new-categories-input" placeholder="Add category…">
                </div>
                <div class="category-suggestions" id="new-categories-suggestions"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Inline message bar -->
        <div id="new-messagebar" style="display: none; margin-top: var(--spacingM);"></div>
      </div>
      <div class="flm-dialog-footer">
        <button class="flm-button" id="btn-new-back" style="display: none;">Back</button>
        <button class="flm-button flm-button--primary" id="btn-new-next">Next</button>
        <button class="flm-button" data-dialog-close>Cancel</button>
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════════════════════════════════
       DELETE CONFIRMATION DIALOG
       ════════════════════════════════════════════════════════════════ -->
  <div class="flm-dialog-overlay" id="delete-dialog" data-light-dismiss style="z-index: 1002;">
    <div class="flm-dialog">
      <div class="flm-dialog-header">
        <h2 class="flm-dialog-title">Delete Catalog</h2>
        <button class="flm-dialog-close" data-icon="Cancel" aria-label="Close" data-dialog-close></button>
      </div>
      <div class="flm-dialog-body">
        <p>Are you sure you want to delete <strong id="delete-catalog-name">sec-filings</strong>? This will remove all chunks, abstracts, and classification data. This action cannot be undone.</p>
      </div>
      <div class="flm-dialog-footer">
        <button class="flm-button flm-button--primary" style="background-color: var(--red); border-color: var(--red);" id="btn-confirm-delete">Delete</button>
        <button class="flm-button" data-dialog-close>Cancel</button>
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════════════════════════════════
       UNSAVED CHANGES DIALOG
       ════════════════════════════════════════════════════════════════ -->
  <div class="flm-dialog-overlay" id="unsaved-dialog" data-light-dismiss style="z-index: 1003;">
    <div class="flm-dialog">
      <div class="flm-dialog-header">
        <h2 class="flm-dialog-title">Unsaved Changes</h2>
        <button class="flm-dialog-close" data-icon="Cancel" aria-label="Close" data-dialog-close></button>
      </div>
      <div class="flm-dialog-body">
        <p>You have unsaved changes. What would you like to do?</p>
      </div>
      <div class="flm-dialog-footer">
        <button class="flm-button flm-button--primary" id="btn-unsaved-save">Save</button>
        <button class="flm-button" id="btn-unsaved-discard" style="color: var(--red);">Discard</button>
        <button class="flm-button" data-dialog-close>Cancel</button>
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════════════════════════════════
       REGENERATE ABSTRACTS DIALOG
       ════════════════════════════════════════════════════════════════ -->
  <div class="flm-dialog-overlay" id="regenerate-dialog" data-light-dismiss style="z-index: 1003;">
    <div class="flm-dialog">
      <div class="flm-dialog-header">
        <h2 class="flm-dialog-title">Regenerate Abstracts</h2>
        <button class="flm-dialog-close" data-icon="Cancel" aria-label="Close" data-dialog-close></button>
      </div>
      <div class="flm-dialog-body">
        <p>Abstract generation rules have changed. Regenerate abstracts now?</p>
      </div>
      <div class="flm-dialog-footer">
        <button class="flm-button flm-button--primary" id="btn-regenerate-confirm">Regenerate</button>
        <button class="flm-button" id="btn-regenerate-skip">Skip</button>
      </div>
    </div>
  </div>

  <!-- Combined library JS -->
  <script src="../scripts/fluentlm.min.js"></script>
  <script src="../scripts/awarity-v2.js"></script>

  <script>
    (function () {
      // ── Suggested categories ──
      var SUGGESTED_CATEGORIES = ['finance', 'legal', 'compliance', 'security', 'research', 'regulatory', 'technical', 'communications', 'triage', 'extraction'];

      // ── Mock Data ──
      var MOCK_CATALOGS = [
        {
          name: 'sec-filings',
          description: 'SEC filings corpus including 10-K, 10-Q, and 8-K documents.',
          categories: ['finance', 'regulatory'],
          documents: 2341,
          chunks: 18420,
          abstracts: 2341,
          classifications: 3,
          status: 'ready',
          lastUpdated: 'Feb 20, 2026',
          location: '~/.awarity/catalogs/sec-filings',
          created: 'Feb 14, 2026',
          abstractRules: 'Summarize each document in 2-3 sentences.\nFocus on financial metrics, risk disclosures, and forward-looking statements.\nInclude key dates and monetary figures.',
          usage: {
            explore: [
              { name: 'Top risk disclosures across SEC filings', lastUsed: '2 hours ago' },
              { name: 'Cybersecurity incident analysis', lastUsed: '1 day ago' },
              { name: 'Liquidity risk assessment Q4', lastUsed: '3 days ago' }
            ],
            workflows: [
              { name: 'Weekly risk digest', lastUsed: '1 day ago' },
              { name: 'New filing triage', lastUsed: '4 days ago' }
            ],
            classifications: [
              { name: 'risk-type classifier', lastUsed: '2 days ago' },
              { name: 'severity-level classifier', lastUsed: '5 days ago' }
            ]
          }
        },
        {
          name: 'legal-contracts',
          description: 'Collection of legal contracts and agreements.',
          categories: ['legal', 'compliance'],
          documents: 847,
          chunks: 6120,
          abstracts: 0,
          classifications: 0,
          status: 'abstracts-missing',
          lastUpdated: 'Feb 19, 2026',
          location: '~/.awarity/catalogs/legal-contracts',
          created: 'Feb 16, 2026',
          abstractRules: '',
          usage: {
            explore: [],
            workflows: [],
            classifications: []
          }
        },
        {
          name: 'research-papers',
          description: 'Academic and technical research papers on AI and ML topics.',
          categories: ['research', 'technical'],
          documents: 512,
          chunks: 3840,
          abstracts: 287,
          classifications: 1,
          status: 'processing',
          lastUpdated: 'Feb 21, 2026',
          location: '~/.awarity/catalogs/research-papers',
          created: 'Feb 10, 2026',
          abstractRules: 'Extract key findings, methodology, and conclusions.\nHighlight novel contributions and limitations.',
          usage: {
            explore: [
              { name: 'Latest advances in transformer architectures', lastUsed: '1 day ago' }
            ],
            workflows: [
              { name: 'Research digest', lastUsed: '3 days ago' }
            ],
            classifications: [
              { name: 'domain classifier', lastUsed: '2 days ago' }
            ]
          }
        },
        {
          name: 'email-archive',
          description: '',
          categories: ['communications'],
          documents: 4200,
          chunks: null,
          abstracts: null,
          classifications: 0,
          status: 'error',
          lastUpdated: 'Feb 18, 2026',
          location: '~/.awarity/catalogs/email-archive',
          created: 'Feb 18, 2026',
          error: 'Ingest failed: unable to parse 12 documents. Check source files for encoding issues.',
          abstractRules: '',
          usage: {
            explore: [],
            workflows: [],
            classifications: []
          }
        },
        {
          name: 'compliance-docs',
          description: 'Compliance documentation across regulatory frameworks.',
          categories: ['compliance', 'regulatory', 'legal'],
          documents: 1105,
          chunks: 8930,
          abstracts: 1105,
          classifications: 5,
          status: 'ready',
          lastUpdated: 'Feb 17, 2026',
          location: '~/.awarity/catalogs/compliance-docs',
          created: 'Feb 5, 2026',
          abstractRules: 'Summarize regulatory obligations and compliance requirements.\nIdentify specific regulation references (e.g. SOX, GDPR, HIPAA).\nNote any deadlines or enforcement actions.',
          usage: {
            explore: [
              { name: 'GDPR compliance gaps', lastUsed: '3 days ago' },
              { name: 'SOX audit requirements', lastUsed: '1 week ago' }
            ],
            workflows: [
              { name: 'Compliance monitoring', lastUsed: '2 days ago' },
              { name: 'Regulatory change alerts', lastUsed: '5 days ago' }
            ],
            classifications: [
              { name: 'regulation-type classifier', lastUsed: '4 days ago' },
              { name: 'risk-level classifier', lastUsed: '5 days ago' }
            ]
          }
        }
      ];

      // ── State ──
      var currentCatalog = null;
      var isDirty = false;
      var abstractRulesDirty = false;
      var editCategories = [];
      var newCategories = [];
      var initialSnapshot = {};

      // ── Refs ──
      var detailPanel = document.getElementById('detail-panel');
      var detailOverlay = document.getElementById('detail-panel-overlay');
      var detailTitle = document.getElementById('detail-panel-title');
      var detailSubtitle = document.getElementById('detail-panel-subtitle');
      var newCatalogDialog = document.getElementById('new-catalog-dialog');
      var deleteDialog = document.getElementById('delete-dialog');
      var unsavedDialog = document.getElementById('unsaved-dialog');
      var regenerateDialog = document.getElementById('regenerate-dialog');
      var messageZone = document.getElementById('messagebar-zone');

      awarity.initThemeToggle();

      // ── Panel Helpers ──
      function openPanel(panel, overlay) {
        panel.classList.add('flm-panel--open');
        overlay.classList.add('flm-panel-overlay--visible');
      }

      function closePanel(panel, overlay) {
        panel.classList.remove('flm-panel--open');
        overlay.classList.remove('flm-panel-overlay--visible');
      }

      // ── Category Tags Rendering ──
      function renderCategoryTags(prefix) {
        var cats = prefix === 'edit' ? editCategories : newCategories;
        var wrap = document.getElementById(prefix + '-categories-wrap');
        var input = document.getElementById(prefix + '-categories-input');
        // Remove existing tags
        wrap.querySelectorAll('.category-tag').forEach(function (t) { t.remove(); });
        // Add tags before input
        cats.forEach(function (cat) {
          var tag = document.createElement('span');
          tag.className = 'category-tag';
          tag.innerHTML = cat + ' <button class="category-tag-remove" data-cat="' + cat + '">&times;</button>';
          wrap.insertBefore(tag, input);
        });
        // Bind remove buttons
        wrap.querySelectorAll('.category-tag-remove').forEach(function (btn) {
          btn.addEventListener('click', function (e) {
            e.stopPropagation();
            var val = btn.getAttribute('data-cat');
            if (prefix === 'edit') {
              editCategories = editCategories.filter(function (c) { return c !== val; });
              renderCategoryTags('edit');
              checkDirty();
            } else {
              newCategories = newCategories.filter(function (c) { return c !== val; });
              renderCategoryTags('new');
            }
          });
        });
      }

      // ── Category Input Setup ──
      function setupCategoryInput(prefix) {
        var input = document.getElementById(prefix + '-categories-input');
        var suggestions = document.getElementById(prefix + '-categories-suggestions');

        input.addEventListener('input', function () {
          var val = this.value.toLowerCase().trim();
          var cats = prefix === 'edit' ? editCategories : newCategories;
          if (!val) { suggestions.style.display = 'none'; return; }

          var matches = SUGGESTED_CATEGORIES.filter(function (s) {
            return s.indexOf(val) !== -1 && cats.indexOf(s) === -1;
          });

          if (matches.length === 0) { suggestions.style.display = 'none'; return; }

          suggestions.innerHTML = matches.map(function (m) {
            return '<div class="category-suggestion" data-value="' + m + '">' + m + '</div>';
          }).join('');
          suggestions.style.display = 'block';
        });

        input.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            var val = this.value.trim().replace(/,/g, '').toLowerCase();
            if (!val) return;
            if (prefix === 'edit') {
              if (editCategories.indexOf(val) === -1) { editCategories.push(val); renderCategoryTags('edit'); checkDirty(); }
            } else {
              if (newCategories.indexOf(val) === -1) { newCategories.push(val); renderCategoryTags('new'); }
            }
            this.value = '';
            suggestions.style.display = 'none';
          }
        });

        suggestions.addEventListener('click', function (e) {
          var opt = e.target.closest('.category-suggestion');
          if (!opt) return;
          var val = opt.getAttribute('data-value');
          if (prefix === 'edit') {
            if (editCategories.indexOf(val) === -1) { editCategories.push(val); renderCategoryTags('edit'); checkDirty(); }
          } else {
            if (newCategories.indexOf(val) === -1) { newCategories.push(val); renderCategoryTags('new'); }
          }
          input.value = '';
          suggestions.style.display = 'none';
        });

        input.addEventListener('blur', function () {
          setTimeout(function () { suggestions.style.display = 'none'; }, 200);
        });
      }

      // ── Dirty Tracking ──
      function captureSnapshot() {
        initialSnapshot = {
          name: document.getElementById('edit-name').value,
          description: document.getElementById('edit-description').value,
          categories: editCategories.slice().sort().join(','),
          abstractRules: document.getElementById('edit-abstract-rules').value
        };
        isDirty = false;
        abstractRulesDirty = false;
        updateDirtyState();
      }

      function checkDirty() {
        var currentName = document.getElementById('edit-name').value;
        var currentDesc = document.getElementById('edit-description').value;
        var currentCats = editCategories.slice().sort().join(',');
        var currentRules = document.getElementById('edit-abstract-rules').value;

        abstractRulesDirty = currentRules !== initialSnapshot.abstractRules;
        isDirty = currentName !== initialSnapshot.name ||
                  currentDesc !== initialSnapshot.description ||
                  currentCats !== initialSnapshot.categories ||
                  abstractRulesDirty;
        updateDirtyState();
      }

      function updateDirtyState() {
        var badge = document.getElementById('dirty-badge');
        badge.classList.toggle('dirty-badge--visible', isDirty);
        document.getElementById('btn-save-catalog').disabled = !isDirty;
        document.getElementById('detail-panel-close-btn').textContent = isDirty ? 'Cancel' : 'Close';
      }

      // Bind input events for dirty tracking
      document.getElementById('edit-name').addEventListener('input', checkDirty);
      document.getElementById('edit-description').addEventListener('input', checkDirty);
      document.getElementById('edit-abstract-rules').addEventListener('input', checkDirty);

      // ── Usage Tab Population ──
      function populateUsage(catalog) {
        var u = catalog.usage || {};
        ['explore', 'workflows', 'classifications'].forEach(function (section) {
          var el = document.getElementById('usage-' + section);
          var items = u[section] || [];
          if (items.length === 0) {
            el.innerHTML = '<div class="usage-empty">No usage recorded yet.</div>';
          } else {
            el.innerHTML = items.map(function (item) {
              return '<div class="usage-item"><span class="usage-item-name">' + item.name + '</span><span class="usage-item-date">' + item.lastUsed + '</span></div>';
            }).join('');
          }
        });
      }

      // ── Detail Panel ──
      function openDetailPanel(catalogName) {
        var cat = MOCK_CATALOGS.find(function (c) { return c.name === catalogName; });
        if (!cat) return;

        currentCatalog = cat;

        detailTitle.textContent = cat.name;
        detailSubtitle.textContent = 'Last updated ' + cat.lastUpdated;

        // Edit tab fields
        document.getElementById('edit-name').value = cat.name;
        document.getElementById('edit-description').value = cat.description || '';
        editCategories = (cat.categories || []).slice();
        renderCategoryTags('edit');

        // Details grid
        document.getElementById('detail-documents').textContent = cat.documents ? cat.documents.toLocaleString() : '—';
        document.getElementById('detail-chunks').textContent = cat.chunks ? cat.chunks.toLocaleString() : '—';
        document.getElementById('detail-abstracts').textContent = cat.abstracts != null ? cat.abstracts.toLocaleString() : '—';
        document.getElementById('detail-classifications').textContent = cat.classifications;
        document.getElementById('detail-location').textContent = cat.location;
        document.getElementById('detail-created').textContent = cat.created;

        // Status badge
        var panelStatusMap = {
          'ready': '<span class="status-badge status-badge--ready"><span class="status-dot"></span> Ready</span>',
          'abstracts-missing': '<span class="status-badge status-badge--warning"><span class="status-dot"></span> Abstracts Missing</span>',
          'processing': '<span class="status-badge status-badge--processing"><span class="status-dot"></span> Processing</span>',
          'error': '<span class="status-badge status-badge--error"><span class="status-dot"></span> Error</span>'
        };
        document.getElementById('detail-status').innerHTML = panelStatusMap[cat.status] || cat.status;

        // Error state
        document.getElementById('detail-error-bar').style.display = cat.status === 'error' ? 'block' : 'none';

        // Abstracts tab
        document.getElementById('detail-abstract-count').textContent = cat.abstracts != null ? cat.abstracts.toLocaleString() : '—';
        document.getElementById('edit-abstract-rules').value = cat.abstractRules || '';

        // Usage tab
        populateUsage(cat);

        // Reset dirty state and capture snapshot
        captureSnapshot();

        // Reset to Edit tab
        switchDetailTab('edit');

        openPanel(detailPanel, detailOverlay);
      }

      // ── Detail Panel Tabs ──
      function switchDetailTab(tabId) {
        document.querySelectorAll('#detail-pivot-bar .pivot-tab').forEach(function (t) { t.classList.remove('pivot-tab--active'); });
        document.querySelectorAll('#detail-panel .pivot-panel').forEach(function (p) { p.classList.remove('pivot-panel--active'); });
        document.querySelector('#detail-pivot-bar .pivot-tab[data-tab="' + tabId + '"]').classList.add('pivot-tab--active');
        document.getElementById('tab-' + tabId).classList.add('pivot-panel--active');
      }

      document.querySelectorAll('#detail-pivot-bar .pivot-tab').forEach(function (tab) {
        tab.addEventListener('click', function () {
          switchDetailTab(tab.getAttribute('data-tab'));
        });
      });

      // ── Save Catalog ──
      function saveCatalog() {
        if (!currentCatalog) return;
        var name = document.getElementById('edit-name').value.trim();
        if (!name) {
          showMessage('error', 'Catalog name is required.');
          return;
        }

        // Check uniqueness
        var duplicate = MOCK_CATALOGS.find(function (c) {
          return c.name.toLowerCase() === name.toLowerCase() && c !== currentCatalog;
        });
        if (duplicate) {
          showMessage('error', 'A catalog named "' + name + '" already exists.');
          return;
        }

        var wasAbstractRulesDirty = abstractRulesDirty;

        // Write back to catalog
        currentCatalog.name = name;
        currentCatalog.description = document.getElementById('edit-description').value.trim();
        currentCatalog.categories = editCategories.slice();
        currentCatalog.abstractRules = document.getElementById('edit-abstract-rules').value;
        currentCatalog.lastUpdated = 'Feb 21, 2026';

        // Reset dirty
        captureSnapshot();
        renderRows();
        detailTitle.textContent = name;
        showMessage('success', 'Catalog "' + name + '" saved.');

        // If abstract rules changed, prompt regeneration
        if (wasAbstractRulesDirty) {
          regenerateDialog.classList.add('flm-dialog-overlay--open');
        }
      }

      document.getElementById('btn-save-catalog').addEventListener('click', saveCatalog);

      // ── Close/Cancel Behavior ──
      function tryCloseDetailPanel() {
        if (isDirty) {
          unsavedDialog.classList.add('flm-dialog-overlay--open');
        } else {
          closePanel(detailPanel, detailOverlay);
          currentCatalog = null;
        }
      }

      // X button and overlay: prompt if dirty
      document.getElementById('detail-panel-close').addEventListener('click', tryCloseDetailPanel);
      detailOverlay.addEventListener('click', tryCloseDetailPanel);

      // Close/Cancel button: Close when clean, Cancel (close without prompt) when dirty
      document.getElementById('detail-panel-close-btn').addEventListener('click', function () {
        closePanel(detailPanel, detailOverlay);
        currentCatalog = null;
        isDirty = false;
      });

      // ── Unsaved Changes Dialog ──
      document.getElementById('btn-unsaved-save').addEventListener('click', function () {
        unsavedDialog.classList.remove('flm-dialog-overlay--open');
        saveCatalog();
        closePanel(detailPanel, detailOverlay);
        currentCatalog = null;
      });

      document.getElementById('btn-unsaved-discard').addEventListener('click', function () {
        unsavedDialog.classList.remove('flm-dialog-overlay--open');
        isDirty = false;
        abstractRulesDirty = false;
        closePanel(detailPanel, detailOverlay);
        currentCatalog = null;
      });

      unsavedDialog.addEventListener('click', function (e) {
        if (e.target.hasAttribute('data-dialog-close') || e.target === unsavedDialog) {
          unsavedDialog.classList.remove('flm-dialog-overlay--open');
        }
      });

      // ── Regenerate Abstracts Dialog ──
      document.getElementById('btn-regenerate-confirm').addEventListener('click', function () {
        regenerateDialog.classList.remove('flm-dialog-overlay--open');
        showMessage('success', 'Abstracts are being regenerated for "' + (currentCatalog ? currentCatalog.name : '') + '".');
      });

      document.getElementById('btn-regenerate-skip').addEventListener('click', function () {
        regenerateDialog.classList.remove('flm-dialog-overlay--open');
      });

      regenerateDialog.addEventListener('click', function (e) {
        if (e.target.hasAttribute('data-dialog-close') || e.target === regenerateDialog) {
          regenerateDialog.classList.remove('flm-dialog-overlay--open');
        }
      });

      // ── New Catalog Wizard ──
      var newStep = 1;

      function openNewCatalogDialog() {
        newStep = 1;
        newCategories = [];
        document.getElementById('new-step-1').style.display = 'block';
        document.getElementById('new-step-2').style.display = 'none';
        document.getElementById('btn-new-back').style.display = 'none';
        document.getElementById('btn-new-next').textContent = 'Next';
        document.getElementById('new-path').value = '';
        document.getElementById('new-auto-abstracts').checked = false;
        document.getElementById('new-name').value = '';
        document.getElementById('new-description').value = '';
        document.getElementById('new-messagebar').style.display = 'none';
        document.querySelector('input[name="source-type"][value="folder"]').checked = true;
        renderCategoryTags('new');
        newCatalogDialog.classList.add('flm-dialog-overlay--open');
      }

      document.getElementById('btn-new-catalog').addEventListener('click', openNewCatalogDialog);
      document.getElementById('btn-empty-create').addEventListener('click', openNewCatalogDialog);

      // Browse for folder
      var filePicker = document.getElementById('file-picker');
      document.getElementById('btn-browse').addEventListener('click', function () {
        filePicker.click();
      });
      filePicker.addEventListener('change', function () {
        if (filePicker.files.length > 0) {
          var path = filePicker.files[0].webkitRelativePath.split('/')[0];
          document.getElementById('new-path').value = path;
        }
      });

      // Next / Create
      document.getElementById('btn-new-next').addEventListener('click', function () {
        if (newStep === 1) {
          var path = document.getElementById('new-path').value.trim();
          if (!path) {
            document.getElementById('new-messagebar').style.display = 'block';
            document.getElementById('new-messagebar').innerHTML = '<div class="flm-messagebar flm-messagebar--error">Path is required.</div>';
            return;
          }
          document.getElementById('new-messagebar').style.display = 'none';
          newStep = 2;
          document.getElementById('new-step-1').style.display = 'none';
          document.getElementById('new-step-2').style.display = 'block';
          document.getElementById('btn-new-back').style.display = 'inline-block';
          document.getElementById('btn-new-next').textContent = 'Create';
        } else {
          // Create
          var name = document.getElementById('new-name').value.trim();
          if (!name) {
            document.getElementById('new-messagebar').style.display = 'block';
            document.getElementById('new-messagebar').innerHTML = '<div class="flm-messagebar flm-messagebar--error">Name is required.</div>';
            return;
          }
          // Check uniqueness
          if (MOCK_CATALOGS.find(function (c) { return c.name.toLowerCase() === name.toLowerCase(); })) {
            document.getElementById('new-messagebar').style.display = 'block';
            document.getElementById('new-messagebar').innerHTML = '<div class="flm-messagebar flm-messagebar--error">A catalog named "' + name + '" already exists.</div>';
            return;
          }

          var path = document.getElementById('new-path').value.trim();
          var newCatalog = {
            name: name,
            description: document.getElementById('new-description').value.trim(),
            categories: newCategories.slice(),
            documents: 0,
            chunks: 0,
            abstracts: 0,
            classifications: 0,
            status: 'processing',
            lastUpdated: 'Feb 21, 2026',
            location: '~/.awarity/catalogs/' + name,
            created: 'Feb 21, 2026',
            abstractRules: '',
            usage: { explore: [], workflows: [], classifications: [] }
          };

          MOCK_CATALOGS.push(newCatalog);
          newCatalogDialog.classList.remove('flm-dialog-overlay--open');
          renderRows();
          showMessage('success', 'Catalog "' + name + '" created.');
          openDetailPanel(name);
        }
      });

      // Back
      document.getElementById('btn-new-back').addEventListener('click', function () {
        newStep = 1;
        document.getElementById('new-step-1').style.display = 'block';
        document.getElementById('new-step-2').style.display = 'none';
        document.getElementById('btn-new-back').style.display = 'none';
        document.getElementById('btn-new-next').textContent = 'Next';
        document.getElementById('new-messagebar').style.display = 'none';
      });

      // Close new catalog dialog
      newCatalogDialog.addEventListener('click', function (e) {
        if (e.target.hasAttribute('data-dialog-close') || e.target === newCatalogDialog) {
          newCatalogDialog.classList.remove('flm-dialog-overlay--open');
        }
      });

      // ── Delete Dialog ──
      var currentDeleteCatalog = '';

      document.getElementById('btn-delete-catalog').addEventListener('click', function () {
        if (!currentCatalog) return;
        currentDeleteCatalog = currentCatalog.name;
        document.getElementById('delete-catalog-name').textContent = currentDeleteCatalog;
        deleteDialog.classList.add('flm-dialog-overlay--open');
      });

      // Commandbar Delete button (bulk)
      document.getElementById('btn-delete').addEventListener('click', function () {
        var checked = document.querySelectorAll('.flm-detailslist-row[data-catalog] .flm-checkbox-input:checked');
        if (checked.length === 0) return;
        var names = [];
        checked.forEach(function (cb) { names.push(cb.closest('.flm-detailslist-row').getAttribute('data-catalog')); });
        currentDeleteCatalog = names.join(', ');
        document.getElementById('delete-catalog-name').textContent = currentDeleteCatalog;
        deleteDialog.classList.add('flm-dialog-overlay--open');
      });

      document.getElementById('btn-confirm-delete').addEventListener('click', function () {
        deleteDialog.classList.remove('flm-dialog-overlay--open');
        closePanel(detailPanel, detailOverlay);
        currentCatalog = null;
        isDirty = false;
        showMessage('success', 'Catalog "' + currentDeleteCatalog + '" deleted.');
      });

      // Close delete dialog
      deleteDialog.addEventListener('click', function (e) {
        if (e.target.hasAttribute('data-dialog-close') || e.target === deleteDialog) {
          deleteDialog.classList.remove('flm-dialog-overlay--open');
        }
      });

      // ── MessageBar helper ──
      function showMessage(type, text) {
        messageZone.innerHTML = '<div class="flm-messagebar flm-messagebar--' + type + '">' + text + '</div>';
        setTimeout(function () { messageZone.innerHTML = ''; }, 5000);
      }

      // ── Selection & toolbar state ──
      var btnGenerate = document.getElementById('btn-generate');
      var btnDelete = document.getElementById('btn-delete');

      function updateToolbarState() {
        var checkAll = document.getElementById('check-all');
        var rowCheckboxes = catalogsList.querySelectorAll('.flm-detailslist-row[data-catalog] .flm-checkbox-input');
        var count = catalogsList.querySelectorAll('.flm-detailslist-row[data-catalog] .flm-checkbox-input:checked').length;
        btnGenerate.disabled = count === 0;
        btnDelete.disabled = count === 0;
        if (checkAll) {
          checkAll.checked = count > 0 && count === rowCheckboxes.length;
          checkAll.indeterminate = count > 0 && count < rowCheckboxes.length;
        }
      }

      // ── Column definitions ──
      var COLUMNS = [
        { key: 'categories',      label: 'Categories',      minWidth: 140, number: false },
        { key: 'documents',       label: 'Documents',       minWidth: 80,  number: true },
        { key: 'chunks',          label: 'Chunks',          minWidth: 80,  number: true },
        { key: 'abstracts',       label: 'Abstracts',       minWidth: 80,  number: true },
        { key: 'classifications', label: 'Classifications', minWidth: 80,  number: true },
        { key: 'lastUpdated',     label: 'Last Updated',    minWidth: 100, number: false },
        { key: 'status',          label: 'Status',          minWidth: 120, number: false }
      ];

      var _measureCtx = document.createElement('canvas').getContext('2d');
      var _cs = getComputedStyle(document.documentElement);
      _measureCtx.font = '600 ' + (_cs.getPropertyValue('--fontSizeSmall').trim() || '12px') + ' ' + (_cs.getPropertyValue('--fontFamily').trim() || '"Segoe UI", sans-serif');
      function colWidth(col) {
        var labelW = Math.ceil(_measureCtx.measureText(col.label).width) + 28;
        return Math.max(col.minWidth, labelW);
      }
      var visibleColumns = { categories: true, documents: true, status: true };

      function getVisibleColumns() {
        return COLUMNS.filter(function (col) { return visibleColumns[col.key]; });
      }

      // ── Render Table Rows ──
      var catalogsList = document.getElementById('catalogs-list');
      var catalogsHeader = document.getElementById('catalogs-header');
      var statusMap = {
        'ready': '<span class="status-badge status-badge--ready"><span class="status-dot"></span> Ready</span>',
        'abstracts-missing': '<span class="status-badge status-badge--warning"><span class="status-dot"></span> Abstracts Missing</span>',
        'processing': '<span class="status-badge status-badge--processing"><span class="status-dot"></span> Processing</span>',
        'error': '<span class="status-badge status-badge--error"><span class="status-dot"></span> Error</span>'
      };

      function colStyle(col, isLast) {
        var w = colWidth(col) + 'px';
        return isLast ? 'min-width: ' + w + '; flex: 1;' : 'width: ' + w + ';';
      }

      function renderHeader() {
        var visCols = getVisibleColumns();
        catalogsHeader.innerHTML =
          '<div class="flm-detailslist-check"><label class="flm-checkbox"><input type="checkbox" class="flm-checkbox-input" id="check-all"><span class="flm-checkbox-mark"></span></label></div>' +
          '<div class="flm-detailslist-header-cell" style="width: 200px;">Name</div>';
        visCols.forEach(function (col, i) {
          var isLast = i === visCols.length - 1;
          catalogsHeader.innerHTML += '<div class="flm-detailslist-header-cell' + (col.number ? ' cell-number' : '') + '" style="' + colStyle(col, isLast) + '">' + col.label + '</div>';
        });
        var checkAll = document.getElementById('check-all');
        checkAll.addEventListener('change', function () {
          var checked = checkAll.checked;
          catalogsList.querySelectorAll('.flm-detailslist-row[data-catalog] .flm-checkbox-input').forEach(function (cb) { cb.checked = checked; });
          updateToolbarState();
        });
      }

      function cellHtml(col, cat) {
        switch (col.key) {
          case 'categories':
            var chips = (cat.categories || []).map(function (c) { return '<span class="category-chip">' + c + '</span>'; }).join('');
            return '<div class="category-chips">' + chips + '</div>';
          case 'documents': return cat.documents ? cat.documents.toLocaleString() : '—';
          case 'chunks': return cat.chunks ? cat.chunks.toLocaleString() : '—';
          case 'abstracts': return cat.abstracts != null ? cat.abstracts.toLocaleString() : '—';
          case 'classifications': return '' + cat.classifications;
          case 'lastUpdated': return cat.lastUpdated;
          case 'status':
            var html = statusMap[cat.status] || cat.status;
            if (cat.status === 'processing') html += '<div class="row-progress"><div class="flm-progress"><div class="flm-progress-track"><div class="flm-progress-bar" style="width: 56%"></div></div></div></div>';
            return html;
          default: return '';
        }
      }

      function renderRows() {
        var existing = catalogsList.querySelectorAll('.flm-detailslist-row');
        existing.forEach(function (r) { r.remove(); });

        MOCK_CATALOGS.forEach(function (cat) {
          var row = document.createElement('div');
          row.className = 'flm-detailslist-row';
          row.setAttribute('data-catalog', cat.name);
          row.setAttribute('data-search', (cat.name + ' ' + (cat.categories || []).join(' ')).toLowerCase());
          row.setAttribute('data-categories', (cat.categories || []).join(','));

          var visCols = getVisibleColumns();
          var html =
            '<div class="flm-detailslist-check"><label class="flm-checkbox"><input type="checkbox" class="flm-checkbox-input"><span class="flm-checkbox-mark"></span></label></div>' +
            '<div class="flm-detailslist-cell" style="width: 200px; font-weight: var(--fontWeightSemibold);">' + cat.name + '</div>';

          visCols.forEach(function (col, i) {
            var isLast = i === visCols.length - 1;
            html += '<div class="flm-detailslist-cell' + (col.number ? ' cell-number' : '') + '" style="' + colStyle(col, isLast) + '">' + cellHtml(col, cat) + '</div>';
          });

          row.innerHTML = html;
          catalogsList.appendChild(row);
        });

        bindRowEvents();
        if (typeof buildFilterBar === 'function') { buildFilterBar(); applyFilters(); }
      }

      function bindRowEvents() {
        catalogsList.querySelectorAll('.flm-detailslist-row[data-catalog]').forEach(function (row) {
          row.addEventListener('click', function (e) {
            if (e.target.closest('.flm-detailslist-check')) return;
            var chip = e.target.closest('.category-chip');
            if (chip) { setCategory(chip.textContent); return; }
            openDetailPanel(row.getAttribute('data-catalog'));
          });
        });

        catalogsList.querySelectorAll('.flm-detailslist-row[data-catalog] .flm-checkbox-input').forEach(function (cb) {
          cb.addEventListener('change', updateToolbarState);
        });
      }

      // ── View dropdown ──
      var viewBtn = document.getElementById('view-dropdown-btn');
      var viewMenu = document.getElementById('view-dropdown-menu');

      function buildViewMenu() {
        viewMenu.innerHTML = '';
        COLUMNS.forEach(function (col) {
          var btn = document.createElement('button');
          btn.className = 'view-dropdown-item';
          var checked = visibleColumns[col.key];
          btn.innerHTML = '<span style="width:16px;text-align:center;">' + (checked ? '&#10003;' : '') + '</span> ' + col.label;
          btn.addEventListener('click', function (e) {
            e.stopPropagation();
            visibleColumns[col.key] = !visibleColumns[col.key];
            renderHeader();
            renderRows();
            buildViewMenu();
          });
          viewMenu.appendChild(btn);
        });
      }

      viewBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        viewMenu.classList.toggle('view-dropdown-menu--open');
        if (viewMenu.classList.contains('view-dropdown-menu--open')) buildViewMenu();
      });

      document.addEventListener('click', function () {
        viewMenu.classList.remove('view-dropdown-menu--open');
      });

      // ── Category filter bar ──
      var activeCategory = 'All';

      function buildFilterBar() {
        var cats = {};
        MOCK_CATALOGS.forEach(function (c) {
          (c.categories || []).forEach(function (cat) { cats[cat] = true; });
        });
        var sorted = Object.keys(cats).sort();
        var items = document.querySelector('#category-filter .flm-overflowset-items');
        items.innerHTML = '';
        ['All'].concat(sorted).forEach(function (cat) {
          var btn = document.createElement('button');
          btn.className = 'flm-overflowset-item filter-pill' + (cat === activeCategory ? ' filter-pill--active' : '');
          btn.setAttribute('data-category', cat);
          btn.textContent = cat;
          btn.addEventListener('click', function () { setCategory(cat); });
          items.appendChild(btn);
        });
      }

      function setCategory(cat) {
        activeCategory = cat;
        document.querySelectorAll('#category-filter .filter-pill').forEach(function (btn) {
          btn.classList.toggle('filter-pill--active', btn.getAttribute('data-category') === cat);
        });
        applyFilters();
      }

      function applyFilters() {
        var query = document.getElementById('search-input').value.toLowerCase();
        catalogsList.querySelectorAll('.flm-detailslist-row[data-catalog]').forEach(function (row) {
          var searchMatch = row.getAttribute('data-search').indexOf(query) !== -1;
          var catMatch = activeCategory === 'All' || (',' + row.getAttribute('data-categories') + ',').indexOf(',' + activeCategory + ',') !== -1;
          row.style.display = (searchMatch && catMatch) ? '' : 'none';
        });
      }

      // ── Search filter ──
      document.getElementById('search-input').addEventListener('input', function () {
        applyFilters();
      });

      // ── Refresh button ──
      document.getElementById('btn-refresh').addEventListener('click', function () {
        showMessage('info', 'Catalog list refreshed.');
      });

      // ── State switcher (for demo: toggle via console) ──
      window.showState = function (state) {
        document.getElementById('state-loading').style.display = state === 'loading' ? 'block' : 'none';
        document.getElementById('state-empty').style.display = state === 'empty' ? 'flex' : 'none';
        document.getElementById('state-data').style.display = state === 'data' ? 'block' : 'none';
      };

      // ── Init ──
      setupCategoryInput('edit');
      setupCategoryInput('new');
      renderHeader();
      renderRows();
      buildFilterBar();

      // Default: show data state
      window.showState('data');

    })();
  </script>
</body>
</html>
